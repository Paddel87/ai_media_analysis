name: ğŸ” Linter Compliance Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  linter-compliance:
    name: ğŸ” Comprehensive Linter Compliance
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.11]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-ci.txt
        pip install black isort flake8 mypy bandit safety

    - name: ğŸ¨ Black Format Check (CRITICAL)
      run: |
        echo "ğŸ” Checking Black formatting compliance..."
        python -m black --check --diff services/ tests/ scripts/
      continue-on-error: false

    - name: ğŸ”§ Import Sort Check (CRITICAL)
      run: |
        echo "ğŸ” Checking import sorting compliance..."
        python -m isort --check-only --diff services/ tests/ scripts/ --profile black
      continue-on-error: false

    - name: ğŸ“‹ flake8 Code Quality Check (CRITICAL)
      run: |
        echo "ğŸ” Checking code quality with flake8..."
        python -m flake8 services/ tests/ scripts/ --max-line-length=88 --ignore=E203,W503
      continue-on-error: false

    - name: ğŸ—ï¸ Configuration Validation (CRITICAL)
      run: |
        echo "ğŸ” Validating configuration files..."
        python scripts/validate_config.py --comprehensive
      continue-on-error: false

    - name: ğŸ”’ Security Scan with bandit (WARNING)
      run: |
        echo "ğŸ” Running security scan..."
        python -m bandit -r services/ --severity-level medium --confidence-level medium -f json -o bandit-report.json || echo "âš ï¸ Security warnings found"
        python -m bandit -r services/ --severity-level medium --confidence-level medium || echo "âš ï¸ Security warnings found"
      continue-on-error: true

    - name: ğŸ›¡ï¸ Dependency Security Check (WARNING)
      run: |
        echo "ğŸ” Checking dependency security..."
        python -m safety check --json --output safety-report.json || echo "âš ï¸ Dependency warnings found"
        python -m safety check || echo "âš ï¸ Dependency warnings found"
      continue-on-error: true

    - name: ğŸ·ï¸ Type Checking with mypy (WARNING)
      run: |
        echo "ğŸ” Running type checking..."
        python -m mypy services/ --ignore-missing-imports --json-report mypy-report || echo "âš ï¸ Type checking warnings found"
        python -m mypy services/ --ignore-missing-imports || echo "âš ï¸ Type checking warnings found"
      continue-on-error: true

    - name: ğŸ“Š Generate Compliance Report
      if: always()
      run: |
        echo "ğŸ“Š Generating compliance report..."
        mkdir -p reports/

        echo "# Linter Compliance Report" > reports/compliance-report.md
        echo "**Generated**: $(date)" >> reports/compliance-report.md
        echo "**Commit**: ${{ github.sha }}" >> reports/compliance-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> reports/compliance-report.md
        echo "" >> reports/compliance-report.md

        echo "## ğŸ¯ Critical Checks (Must Pass)" >> reports/compliance-report.md
        echo "- âœ… Black formatting" >> reports/compliance-report.md
        echo "- âœ… Import sorting" >> reports/compliance-report.md
        echo "- âœ… flake8 code quality" >> reports/compliance-report.md
        echo "- âœ… Configuration validation" >> reports/compliance-report.md
        echo "" >> reports/compliance-report.md

        echo "## âš ï¸ Warning Checks (Recommended)" >> reports/compliance-report.md
        echo "- ğŸ”’ Security scan results available" >> reports/compliance-report.md
        echo "- ğŸ›¡ï¸ Dependency check results available" >> reports/compliance-report.md
        echo "- ğŸ·ï¸ Type checking results available" >> reports/compliance-report.md
        echo "" >> reports/compliance-report.md

        if [ -f "bandit-report.json" ]; then
          echo "## ğŸ”’ Security Scan Results" >> reports/compliance-report.md
          echo "\`\`\`json" >> reports/compliance-report.md
          cat bandit-report.json >> reports/compliance-report.md
          echo "\`\`\`" >> reports/compliance-report.md
          echo "" >> reports/compliance-report.md
        fi

        if [ -f "safety-report.json" ]; then
          echo "## ğŸ›¡ï¸ Dependency Security Results" >> reports/compliance-report.md
          echo "\`\`\`json" >> reports/compliance-report.md
          cat safety-report.json >> reports/compliance-report.md
          echo "\`\`\`" >> reports/compliance-report.md
          echo "" >> reports/compliance-report.md
        fi

        echo "## ğŸ“‹ Summary" >> reports/compliance-report.md
        echo "**Status**: âœ… All critical checks passed" >> reports/compliance-report.md
        echo "**Ready for merge**: Yes" >> reports/compliance-report.md

    - name: ğŸ“¤ Upload Compliance Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: linter-compliance-report
        path: reports/compliance-report.md

    - name: ğŸ“¤ Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          mypy-report/
      continue-on-error: true

  compliance-summary:
    name: ğŸ“Š Compliance Summary
    runs-on: ubuntu-latest
    needs: linter-compliance
    if: always()

    steps:
    - name: ğŸ“¥ Download Reports
      uses: actions/download-artifact@v3
      with:
        name: linter-compliance-report
        path: reports/
      continue-on-error: true

    - name: ğŸ“‹ Display Summary
      run: |
        echo "## ğŸ¯ Linter Compliance Summary"
        echo ""
        echo "### âœ… Critical Compliance Checks"
        echo "All critical linter checks must pass for merge approval:"
        echo "- ğŸ¨ Black formatting"
        echo "- ğŸ”§ Import sorting (isort)"
        echo "- ğŸ“‹ Code quality (flake8)"
        echo "- ğŸ—ï¸ Configuration validation"
        echo ""
        echo "### âš ï¸ Warning Checks"
        echo "These provide additional insights but don't block merges:"
        echo "- ğŸ”’ Security scanning (bandit)"
        echo "- ğŸ›¡ï¸ Dependency security (safety)"
        echo "- ğŸ·ï¸ Type checking (mypy)"
        echo ""
        echo "### ğŸ“Š Results"
        if [ -f "reports/compliance-report.md" ]; then
          cat reports/compliance-report.md
        else
          echo "âš ï¸ Compliance report not available"
        fi

    - name: âœ… Mark as Success
      run: echo "ğŸ‰ Linter compliance check completed successfully!"
